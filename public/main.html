<!DOCTYPE html>
<html>
<head>
    <title>Main Page</title>
    <script>
        let ws;
        let user;
        let testButtonCounts = { user1: 1, user2: 1 }; // Track current state for each user (1, 2, or 3)
        let clickedCards = { user1: [], user2: [] }; // Track clicked cards for both users

        function setupWebSocket() {
            ws = new WebSocket('ws://localhost:3000');

            ws.onmessage = function(event) {
                const state = JSON.parse(event.data);

                // Update the boards for both users
                displayBoard('user1Board', state.user1Board);
                displayBoard('user2Board', state.user2Board);

                // Display the available cards for the user
                if (user === 'user1') {
                    displayCards('user1', state.user1Cards);
                } else {
                    displayCards('user2', state.user2Cards);
                }

                if (state.gameStarted) {
                    disableDealButton();
                }

                if (state.user1Finished) {
                    disableUserButtons('user1');
                    if (state.user2Finished) {
                        reEnableUserButtons('user1');
                        reEnableUserButtons('user2');
                    }
                }

                if (state.user2Finished) {
                    disableUserButtons('user2');
                    if (state.user1Finished) {
                        reEnableUserButtons('user1');
                        reEnableUserButtons('user2');
                    }
                }
                

                if (state.gameEnded) {
                    updateScores(state.user1Score,state.user2Score);
                }
            };
            addTestButton(); // Add the test button when dealing cards
        }

        function disableDealButton() {
            // Disable the Deal Cards button for both users
            document.getElementById('dealCardsButton').disabled = true; // Disable the button
            document.getElementById('dealCardsButton').style.backgroundColor = '#ccc'; // Change button color
            document.getElementById('dealCardsButton').style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
        }

        function displayCards(user, cards) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            cards.forEach((card) => {
                const cardButton = document.createElement('button');
                cardButton.textContent = card;
                cardButton.className = 'card-button'; // 

                // Set a data attribute to identify which user the button belongs to
                cardButton.setAttribute('data-user', user);

                // Disable the button if the card has already been clicked
                if (clickedCards[user].includes(card)) {
                    cardButton.disabled = true; // Disable if card has been clicked already
                    cardButton.style.backgroundColor = '#ccc'; // Change button color to indicate it's clicked
                    cardButton.style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
                }

                cardButton.onclick = function() {
                    // Send the selected card and the row number to the server
                    ws.send(JSON.stringify({
                        action: 'cardClick',
                        user: user,
                        card: card,
                        row: testButtonCounts[user] // Send the row number
                    }));
                    clickedCards[user].push(card); // Track the clicked card
                    cardButton.disabled = true; // Disable this card button after use
                    cardButton.style.backgroundColor = '#ccc'; // Change button color to indicate it's clicked
                    cardButton.style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
                };
                container.appendChild(cardButton);
            });
        }

        function disableUserButtons(user) {
            const cardButtons = document.querySelectorAll('#cardContainer button');
            cardButtons.forEach((button) => {
                if (button.getAttribute('data-user') === user) {
                    button.disabled = true;
                    button.style.backgroundColor = '#ccc'; // Change button color to indicate it's disabled
                    button.style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
                }
            });
        }

        function reEnableUserButtons(user) {
            // Select all card buttons in the cardContainer
            const cardButtons = document.querySelectorAll('#cardContainer button');

            // Loop through each button
            cardButtons.forEach((button) => {
                // Check if the button belongs to the specified user
                if (button.getAttribute('data-user') === user) {
                    // Re-enable the button if it was disabled by the disableUserButtons function
                    if (button.disabled) {
                        button.disabled = false; // Re-enable the button
                        button.style.backgroundColor = ''; // Reset to default background
                        button.style.cursor = 'pointer'; // Reset cursor to indicate clickable state
                    }
                }
            });
        }

        function displayBoard(boardId, board) {
            const boardContainer = document.getElementById(boardId);
            boardContainer.innerHTML = '';

            // Split board into 3 rows: 3 places, 5 places, and 5 places
            const topRow = board.slice(0, 3);
            const middleRow = board.slice(3, 8);
            const bottomRow = board.slice(8, 13);

            // Create row elements for each
            const topRowElement = createRow(topRow,boardId);
            const middleRowElement = createRow(middleRow,boardId);
            const bottomRowElement = createRow(bottomRow,boardId);

            boardContainer.appendChild(topRowElement);
            boardContainer.appendChild(middleRowElement);
            boardContainer.appendChild(bottomRowElement);
        }

        function createRow(cards, boardId) {
            const row = document.createElement('div');
            row.className = 'row';
            cards.forEach((card) => {
                const slot = document.createElement('button'); // Changed from div to button
                slot.className = 'slot';
                slot.textContent = card ? card : 'Empty';

                if ((user === 'user1' && boardId === 'user1Board') || (user === 'user2' && boardId === 'user2Board')){
                // Add onclick event to change color when clicked
                    slot.onclick = function() {
                        if (!slot.classList.contains('clicked')) {
                            slot.classList.add('clicked'); // Add clicked class to change background color
                        } else {
                            slot.classList.remove('clicked'); // Toggle back to unclicked state if pressed again
                        }
                    };
                }

                row.appendChild(slot);
            });
            return row;
        }

        function dealFirst() {
            ws.send(JSON.stringify({ action: 'deal' }));
        }

        function dealCards() {
            ws.send(JSON.stringify({ action: 'dealAgain' }));
        }

        function resetGame() {
            ws.send(JSON.stringify({ action: 'reset' }));
            clickedCards = { user1: [], user2: [] }; // Reset the clicked cards tracker
        }

        function addTestButton() {
            const user1ButtonContainer = document.getElementById('user1-test-button');
            const user2ButtonContainer = document.getElementById('user2-test-button');

            // Add button only if it doesn't exist
            if (user === 'user1' && user1ButtonContainer.innerHTML === '') {
                const testButton = document.createElement('button');
                testButton.textContent = "Row 1"; // Start with "test 1"
                testButton.onclick = function() {
                    // Cycle through the button states
                    testButtonCounts.user1 = (testButtonCounts.user1 % 3) + 1; // Cycle between 1, 2, 3
                    testButton.textContent = `Row ${testButtonCounts.user1}`; // Update button text
                };
                user1ButtonContainer.appendChild(testButton);
            }

            if (user === 'user2' && user2ButtonContainer.innerHTML === '') {
                const testButton = document.createElement('button');
                testButton.textContent = "Row 1"; // Start with "test 1"
                testButton.onclick = function() {
                    // Cycle through the button states
                    testButtonCounts.user2 = (testButtonCounts.user2 % 3) + 1; // Cycle between 1, 2, 3
                    testButton.textContent = `Row ${testButtonCounts.user2}`; // Update button text
                };
                user2ButtonContainer.appendChild(testButton);
            }
        }

        function updateScores(user1Score, user2Score) {
            document.getElementById('user1Score').textContent = user1Score;
            document.getElementById('user2Score').textContent = user2Score;
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            user = urlParams.get('user');

            setupWebSocket();
        };
    </script>
    <style>
        body {
            transform: scale(0.9); /* Scale down to 90% */
            transform-origin: top left; /* Ensure scaling starts from the top-left corner */
            overflow: hidden; /* Prevent scrolling */
        }
        .board {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ccc; /* Add a border for visibility */
            padding: 10px; /* Add padding inside the board */
            margin-right: 10px; /* Space between board and player info */
        }

        .row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .slot {
            width: 60px;
            height: 80px;
            border: 1px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            background-color: white; /* Add a background color for button */
            cursor: pointer; /* Ensure cursor changes to indicate it's clickable */
        }

        .slot.clicked {
            background-color: lightblue; /* Change this to any color you want */
        }

        .slot.empty {
            background-color: #f0f0f0;
        }

        .test-button-container {
            margin-top: 10px; /* Spacing above the test button */
            display: flex; /* Ensure buttons are next to the name */
            align-items: center;
        }

        .player-info {
            display: flex; /* Align text vertically */
            align-items: center; /* Center items vertically */
            flex-direction: column; /* Stack the name and score */
            margin-left: 10px; /* Space between the board and player info */
            vertical-align: top; /* Align with the top of the board */
            font-family: Arial, sans-serif; /* Font style */
            font-size: 14px; /* Font size */
        }

        .cardContainer {
            display: flex; /* Use flexbox to display buttons in a row */
            flex-wrap: wrap; /* Allow buttons to wrap to the next line if needed */
            margin-top: 5px; /* Add some space above the card buttons */
        }

        .card-button {
            width: 60px; /* Match the width of slots */
            height: 80px; /* Match the height of slots */
            margin: 5px; /* Space between buttons */
        }

        .card-button.disabled {
            background-color: #ccc; /* Change color for disabled state */
            cursor: not-allowed; /* Change cursor for disabled state */
        }
    </style>
</head>
<body>
    <h1>Pineapple Poker Online</h1>

    <h2></h2>
    <button id="dealCardsButton" onclick="dealFirst()">Start Game</button>
    <button onclick="resetGame()">Reset Game</button>

    <h2>Your Cards</h2>
    <div id="cardContainer" class="card-container"></div>

    <h2>Rike's Board</h2>
    <div style="display: flex; align-items: center;">
        <div id="user1Board" class="board"></div>
        <div id="user1-info" class="player-info">
            <strong>Score:</strong> <span id="user1Score"></span>
        </div>
    </div>
    <div id="user1-test-button" class="test-button-container"></div>

    <h2>Cuco's Board</h2>
    <div style="display: flex; align-items: center;">
        <div id="user2Board" class="board"></div>
        <div id="user2-info" class="player-info">
            <strong>Score:</strong> <span id="user2Score"></span>
        </div>
    </div>
    <div id="user2-test-button" class="test-button-container"></div>
</body>
</html>
