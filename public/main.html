<!DOCTYPE html>
<html>
<head>
    <title>Main Page</title>
    <script>
        let ws;
        let user;
        let testButtonCounts = { user1: 1, user2: 1 }; // Track current state for each user (1, 2, or 3)
        let clickedCards = { user1: [], user2: [] }; // Track clicked cards for both users

        function setupWebSocket() {
            ws = new WebSocket('ws://localhost:3000');

            ws.onmessage = function(event) {
                const state = JSON.parse(event.data);

                // Update the boards for both users
                displayBoard('user1Board', state.user1Board);
                displayBoard('user2Board', state.user2Board);

                // Display the available cards for the user
                if (user === 'user1') {
                    displayCards('user1', state.user1Cards);
                } else {
                    displayCards('user2', state.user2Cards);
                }

                if (state.gameEnded) {
                    alert('Game over! Both users have placed all their cards.');
                }
            };
            addTestButton(); // Add the test button when dealing cards
        }

        function displayCards(user, cards) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            cards.forEach((card) => {
                const cardButton = document.createElement('button');
                cardButton.textContent = card;

                // Disable the button if the card has already been clicked
                if (clickedCards[user].includes(card)) {
                    cardButton.disabled = true; // Disable if card has been clicked already
                    cardButton.style.backgroundColor = '#ccc'; // Change button color to indicate it's clicked
                    cardButton.style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
                }

                cardButton.onclick = function() {
                    // Send the selected card and the row number to the server
                    ws.send(JSON.stringify({
                        action: 'cardClick',
                        user: user,
                        card: card,
                        row: testButtonCounts[user] // Send the row number
                    }));
                    clickedCards[user].push(card); // Track the clicked card
                    cardButton.disabled = true; // Disable this card button after use
                    cardButton.style.backgroundColor = '#ccc'; // Change button color to indicate it's clicked
                    cardButton.style.cursor = 'not-allowed'; // Change cursor to indicate disabled state
                };
                container.appendChild(cardButton);
            });
        }

        function displayBoard(boardId, board) {
            const boardContainer = document.getElementById(boardId);
            boardContainer.innerHTML = '';

            // Split board into 3 rows: 3 places, 5 places, and 5 places
            const topRow = board.slice(0, 3);
            const middleRow = board.slice(3, 8);
            const bottomRow = board.slice(8, 13);

            // Create row elements for each
            const topRowElement = createRow(topRow);
            const middleRowElement = createRow(middleRow);
            const bottomRowElement = createRow(bottomRow);

            boardContainer.appendChild(topRowElement);
            boardContainer.appendChild(middleRowElement);
            boardContainer.appendChild(bottomRowElement);
        }

        function createRow(cards) {
            const row = document.createElement('div');
            row.className = 'row';
            cards.forEach((card) => {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.textContent = card ? card : 'Empty';
                row.appendChild(slot);
            });
            return row;
        }

        function dealCards() {
            ws.send(JSON.stringify({ action: 'deal' }));
        }

        function resetGame() {
            ws.send(JSON.stringify({ action: 'reset' }));
            clickedCards = { user1: [], user2: [] }; // Reset the clicked cards tracker
        }

        function addTestButton() {
            const user1ButtonContainer = document.getElementById('user1-test-button');
            const user2ButtonContainer = document.getElementById('user2-test-button');

            // Add button only if it doesn't exist
            if (user === 'user1' && user1ButtonContainer.innerHTML === '') {
                const testButton = document.createElement('button');
                testButton.textContent = "test 1"; // Start with "test 1"
                testButton.onclick = function() {
                    // Cycle through the button states
                    testButtonCounts.user1 = (testButtonCounts.user1 % 3) + 1; // Cycle between 1, 2, 3
                    testButton.textContent = `test ${testButtonCounts.user1}`; // Update button text
                };
                user1ButtonContainer.appendChild(testButton);
            }

            if (user === 'user2' && user2ButtonContainer.innerHTML === '') {
                const testButton = document.createElement('button');
                testButton.textContent = "test 1"; // Start with "test 1"
                testButton.onclick = function() {
                    // Cycle through the button states
                    testButtonCounts.user2 = (testButtonCounts.user2 % 3) + 1; // Cycle between 1, 2, 3
                    testButton.textContent = `test ${testButtonCounts.user2}`; // Update button text
                };
                user2ButtonContainer.appendChild(testButton);
            }
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            user = urlParams.get('user');

            setupWebSocket();
        };
    </script>
    <style>
        .board {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .slot {
            width: 60px;
            height: 80px;
            border: 1px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
        }

        .slot.empty {
            background-color: #f0f0f0;
        }

        .test-button-container {
            margin-top: 10px; /* Spacing above the test button */
            display: flex; /* Ensure buttons are next to the name */
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Main Page</h1>

    <h2>Game Controls</h2>
    <button onclick="dealCards()">Deal Cards</button>
    <button onclick="resetGame()">Reset Game</button>

    <h2>Your Cards</h2>
    <div id="cardContainer"></div>

    <h2>User 1 Board</h2>
    <div id="user1Board" class="board"></div>
    <div id="user1-test-button" class="test-button-container"></div>

    <h2>User 2 Board</h2>
    <div id="user2Board" class="board"></div>
    <div id="user2-test-button" class="test-button-container"></div>
</body>
</html>
